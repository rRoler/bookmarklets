/*!
 * Licensed under MIT: https://github.com/rRoler/bookmarklets/raw/main/LICENSE
 * Third party licenses: https://github.com/rRoler/bookmarklets/raw/main/dist/mangadex-show_cover_data-v3.6.dependencies.txt
 */

javascript:(() => {function e(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=e.match(t);if(n&&n[r])return n[r]}function t(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;const r=[...e],n=[];for(;r.length;)n.push(r.splice(0,t));return n}function r(e){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");e.svg.attributes&&o(t,e.svg.attributes),e.svg.styles&&n(t,e.svg.styles);for(const r of e.paths){const e=document.createElementNS("http://www.w3.org/2000/svg","path");r.attributes&&o(e,r.attributes),r.styles&&n(e,r.styles),t.append(e)}return t}function n(e,t){for(const r in t)e.style.setProperty(r,t[r])}function o(e,t){for(const r in t)e.setAttribute(r,t[r])}const a=e(window.location.pathname,/\/title\/(?:edit\/)?([-0-9a-f]{20,})/,1),i=(/draft=true/.test(window.location.search),(e,t)=>function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"/",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=new URL(e);n.pathname=t;for(const e in r){const t=r[e];if(Array.isArray(t))for(const r of t)n.searchParams.append(e,r);else n.searchParams.set(e,t.toString())}return n}("https://api.mangadex.org",e,t));let s={text:"#000",primary:"#b5e853",background:"#fff",accent:"#3c3c3c"};class c{constructor(){this.element=document.createElement("div")}add=()=>document.body.appendChild(this.element);remove=()=>this.element.remove()}const d="rgb(var(--md-color))",l="rgb(var(--md-primary))",u="rgb(var(--md-background))",g="rgb(var(--md-accent))",p="rgb(var(--md-accent-20))",m=()=>{return e={text:d,primary:l,background:u,accent:g},void(s={...s,...e});var e},h={ROLE_BANNED:"rgb(0, 0, 0)",ROLE_ADMIN:"rgb(155, 89, 182)",ROLE_DEVELOPER:"rgb(255, 110, 233)",ROLE_DESIGNER:"rgb(254, 110, 171)",ROLE_GLOBAL_MODERATOR:"rgb(233, 30, 99)",ROLE_FORUM_MODERATOR:"rgb(233, 30, 99)",ROLE_PUBLIC_RELATIONS:"rgb(230, 126, 34)",ROLE_STAFF:"rgb(233, 30, 99)",ROLE_VIP:"rgb(241, 196, 15)",ROLE_POWER_UPLOADER:"rgb(46, 204, 113)",ROLE_CONTRIBUTOR:"rgb(32, 102, 148)",ROLE_GROUP_LEADER:"rgb(52, 152, 219)",ROLE_MD_AT_HOME:"rgb(26, 121, 57)",ROLE_GROUP_MEMBER:"rgb(250, 250, 250)",ROLE_MEMBER:"rgb(250, 250, 250)",ROLE_USER:"rgb(250, 250, 250)",ROLE_GUEST:"rgb(250, 250, 250)",ROLE_UNVERIFIED:"rgb(250, 250, 250)"};console.debug("heroicons","included");const f={svg:{attributes:{fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},styles:{width:"1.5rem",height:"1.5rem"}},paths:[{attributes:{"stroke-linecap":"round","stroke-linejoin":"round"}}]},b={svg:{attributes:{fill:"currentColor",viewBox:"0 0 20 20"},styles:{width:"1.25rem",height:"1.25rem"}},paths:[{attributes:{"fill-rule":"evenodd","clip-rule":"evenodd"}}]};class v extends c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;super();const t=document.createElement("div");n(t,{"z-index":"1000",position:"fixed",bottom:"0",left:"0",width:"100%",height:"24px","background-color":s.accent,cursor:"pointer"});const r=document.createElement("div");n(r,{height:"100%","background-color":s.primary,transition:"width 200ms"}),this.bar=r,this.update(e),t.append(r),t.addEventListener("click",this.remove),this.element=t}update(e){const t=Math.ceil(parseInt(this.bar.style.getPropertyValue("width"))),r=Math.ceil(e);r>=100?this.remove():t!==r&&r>=0&&n(this.bar,{width:`${r}%`})}}(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(function(e,t){if(!new RegExp(e).test(window.location.hostname))return alert("Bookmarklet executed on the wrong website!");t()})("^mangadex.org|canary.mangadex.dev",(()=>{const r=t.createPage&&/\/create\//.test(window.location.pathname),n="You can execute this bookmarklet only on ";return!t.titlePage||a||r?!t.editPage||/\/edit\//.test(window.location.pathname)||r?void e():alert(n+"an edit page!"):alert(n+"a title page!")}))})((()=>{m();const o=100,s=1e3,c=[],d=new Map,u=new Map,E={manga:[],cover:[]},w=new v;if(document.querySelectorAll("img, div").forEach((t=>{const r=t.src||t.style.getPropertyValue("background-image");if(!/\/covers\/+[-0-9a-f]{20,}\/+[-0-9a-f]{20,}[^/]+(?:[?#].*)?$/.test(r)||t.classList.contains("banner-image")||t.parentElement?.classList.contains("banner-bg"))return;const n=e(r,/[-0-9a-f]{20,}/),o=e(r,/([-0-9a-f]{20,}\.[^/.]*)\.[0-9]+\.[^/.?#]*([?#].*)?$/,1)||e(r,/[-0-9a-f]{20,}\.[^/.]*?$/);if(!n||!o)return;const a=e=>{e.has(n)?e.get(n)?.add(o):e.set(n,new Set([o]))};"executed"!==t.getAttribute("cover-data-bookmarklet")?(c.push(t),t.setAttribute("cover-data-bookmarklet","executed"),a(d)):a(u)})),d.size<=0)return document.querySelector('[cover-data-bookmarklet="executed"]')?alert("No new covers were found on this page since the last time this bookmarklet was executed!"):alert("No covers were found on this page!");function A(e,t,o,a){e.setAttribute("cover-data-cover-id",a.id);const i=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=e=>n(e,{display:t?"flex":"none"});e.stopPropagation(),e.preventDefault(),e.shiftKey?document.querySelectorAll(".cover-data-bookmarklet-information").forEach((e=>r(e))):r(v)},s=a.relationships.find((e=>"user"===e.type&&"f8cc4f8a-e596-4618-ab05-ef6572980bbf"!==e.id)),c={size:`${t}x${o}`,version:`Version ${a.attributes.version}`,description:a.attributes.description||void 0,createdAt:`Created at ${new Date(a.attributes.createdAt).toLocaleString("en-US",{hour12:!1})}`,updatedAt:`Updated at ${new Date(a.attributes.updatedAt).toLocaleString("en-US",{hour12:!1})}`,user:s?.attributes?.username,id:`Cover ID ${a.id}`},d=document.createElement("span");n(d,{position:"absolute",top:"0","z-index":"1"});const u=document.createElement("span");n(u,{width:"fit-content",display:"flex",gap:"0.1rem","align-items":"center"}),u.addEventListener("click",i),d.append(u);const m=document.createElement("span");m.innerText=c.size,n(m,{"padding-top":"0.25px"}),u.append(m);const v=document.createElement("span");v.classList.add("cover-data-bookmarklet-information"),n(v,{display:"none",position:"absolute",width:"100%",height:"100%",padding:"0.4rem",gap:"0.2rem",overflow:"auto","flex-wrap":"wrap","align-content":"baseline","background-color":g,"z-index":"2"}),v.addEventListener("click",(e=>i(e,!1)));const E={};for(const e in c){const t=c[e];t?(E[e]=document.createElement("small"),E[e].innerText=t,E[e].setAttribute("title",t),n(E[e],{height:"fit-content","max-width":"100%","flex-grow":"1","text-align":"center","background-color":p,padding:"0.2rem 0.4rem","border-radius":"0.25rem"}),v.append(E[e])):delete c[e]}if(u.setAttribute("title",Object.values(c).join("\n")),E.description&&n(E.description,{width:"100%",border:`1px solid ${l}`}),E.user){const e=(e=>{for(const t in h)if(e.includes(t))return h[t];return h.ROLE_USER})(s.attributes.roles);n(E.user,{width:"100%",color:e,border:`1px solid ${e}`,"background-color":e.replace(")",",0.1)"),overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}),E.user.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),window.open(`/user/${s.id}`,"_blank")}))}E.id.innerText="Copy Cover ID",E.id.addEventListener("click",(e=>{const t=e=>{navigator.clipboard.writeText(e).then((()=>console.debug(`Copied cover ids: ${e}`)),(()=>console.error(`Failed to copy cover ids: ${e}`))).catch(console.error)};if(e.stopPropagation(),e.preventDefault(),e.shiftKey){const e=[];document.querySelectorAll("[cover-data-cover-id]").forEach((t=>{const r=t.getAttribute("cover-data-cover-id");r&&!e.includes(r)&&e.push(r)})),t(e.join(" "))}else t(a.id)})),e instanceof HTMLImageElement?(n(d,{padding:"0.2rem 0.4rem 0.5rem",color:"#fff",left:"0",width:"100%",background:"linear-gradient(0deg,transparent,rgba(0,0,0,0.8))","border-top-right-radius":"0.25rem","border-top-left-radius":"0.25rem"}),c.description&&u.append((()=>{const e=f;return e.paths[0].attributes.d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z",r(e)})()),n(v,{"border-radius":"0.25rem"}),e.parentElement?.append(d,v)):(n(d,{padding:"0 0.2rem","background-color":g,"border-bottom-left-radius":"4px","border-bottom-right-radius":"4px"}),n(m,{"max-height":"1.5rem"}),c.description&&u.append((()=>{const e=b;return e.paths[0].attributes.d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z",r(e)})()),e.append(d,v))}function R(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return new Promise(((n,a)=>{if(r>s)return a(new Error(`Offset is bigger than ${s}!`));t?function(e){let{mangaIds:t,order:r={},includes:n=[],offset:o=0,limit:a=100}=e;return new Promise(((e,s)=>{const c={offset:o,limit:a,"manga[]":t,"includes[]":n};r?.volume&&(c["order[volume]"]=r.volume),fetch(i("/cover",c)).then((t=>e(t.json()))).catch(s)}))}({mangaIds:e,order:{volume:"asc"},includes:["user"],offset:r,limit:o}).then(n).catch(a):function(e){let{ids:t,includes:r=[],contentRating:n=[],offset:o=0,limit:a=100}=e;return new Promise(((e,s)=>{fetch(i("/manga",{offset:o,limit:a,"includes[]":r,"contentRating[]":n,"ids[]":t})).then((t=>e(t.json()))).catch(s)}))}({ids:e,includes:["cover_art"],contentRating:["safe","suggestive","erotica","pornographic"],offset:r,limit:o}).then(n).catch(a)}))}w.add(),d.forEach(((e,t)=>{const r=u.get(t)?.size||0;e.size+r>1||a===t?E.cover.push(t):E.manga.push(t)})),function(){const e=[];return new Promise(((r,n)=>async function(){for(const r in E){const n="cover"===r,o=t(E[r]);for(const t of o){const r=await R(t,n);if(n){e.push(...r.data);for(let o=r.limit;o<r.total;o+=r.limit){const r=await R(t,n,o);e.push(...r.data)}}else r.data.forEach((t=>{const r=t.relationships.find((e=>"cover_art"===e.type));r&&(r.relationships=[{type:t.type,id:t.id}],e.push(r))}))}}return e}().then(r).catch(n)))}().then((e=>{let t=0,r=0;const o=document.createElement("div");n(o,{width:"fit-content",height:"fit-content",opacity:"0",position:"absolute",top:"-10000px","z-index":"-10000","pointer-events":"none"}),document.body.append(o),c.forEach((n=>{const a=n.src||n.style.getPropertyValue("background-image");let i;const s=e.find((e=>{if(i=e.relationships.find((e=>"manga"===e.type)),i&&new RegExp(`${i.id}/${e.attributes.fileName}`).test(a))return e}));if(!s||!i)return console.error(`Element changed primary cover image: ${n}`),++r,void g();let d=0;const l=`https://mangadex.org/covers/${i.id}/${s.attributes.fileName}`,u=new Image;function g(){t+r>=c.length&&(w.remove(),r>0&&alert(`${r} cover images failed to load.\n\nReload the page and execute the bookmarklet again!`))}function p(){u.onerror=()=>{console.error(`Cover image failed to load: ${l}`),++r,g()},u.onload=()=>{u.remove(),o.children.length<=0&&o.remove(),A(n,u.naturalWidth,u.naturalHeight,s),w.update(++t/c.length*100),g()}}u.setAttribute("cover-data-bookmarklet","executed"),o.append(u);try{u.onerror=()=>{console.warn(`Cover image failed to load: ${l}.\nRetrying...`),u.removeAttribute("src"),++d>=4&&p(),u.setAttribute("src",l)},new ResizeObserver(((e,r)=>{if(d>=4)return r.disconnect();const a=u.naturalWidth,i=u.naturalHeight;a>0&&i>0&&(r.disconnect(),u.remove(),u.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NgAAIAAAUAAR4f7BQAAAAASUVORK5CYII=",o.children.length<=0&&o.remove(),A(n,a,i,s),w.update(++t/c.length*100),g())})).observe(u)}catch(e){p()}u.src=l}))})).catch((e=>{console.error(e),alert("Failed to fetch cover data!\n"+e.message)}))}));})();
